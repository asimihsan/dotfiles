##### Completions (set fpath before compinit)
fpath=(/opt/homebrew/share/zsh/site-functions ${fpath:#/usr/local/share/zsh/site-functions})
fpath+=("$HOME/.zsh/completions")
if command -v devbox >/dev/null 2>&1; then
    fpath+=($DEVBOX_GLOBAL_PREFIX/share/zsh/site-functions $DEVBOX_GLOBAL_PREFIX/share/zsh/$ZSH_VERSION/functions $DEVBOX_GLOBAL_PREFIX/share/zsh/vendor-completions)
fi

autoload -U compinit && compinit -u
autoload -U +X bashcompinit && bashcompinit

##### Interactive hooks / prompt / widgets
. "$HOME/.cargo/env" 2>/dev/null || true
. $HOME/bin/logging.sh
[[ -s "/Users/asimi/.gvm/scripts/gvm" ]] && source "/Users/asimi/.gvm/scripts/gvm"
eval "$(direnv hook zsh)"
eval "$(gh copilot alias -- zsh)"
eval "$(starship init zsh)"
eval "$(zoxide init zsh)"
source <(fzf --zsh)
source <(jj util completion zsh)
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

##### Interactive-only PATH tweaks
export PATH="$HOME/.bin:$HOME/bin:/usr/local/bin:$PATH"

##### Homebrew tool paths using HOMEBREW_PREFIX
if [[ -n ${HOMEBREW_PREFIX-} ]]; then
    export PATH="${HOMEBREW_PREFIX}/opt/sqlite/bin:$PATH"
    export PATH="$PATH:${HOMEBREW_PREFIX}/opt/tidy-html5/bin"
    export PATH="${HOMEBREW_PREFIX}/opt/protobuf/bin:$PATH"
    export PATH="/opt/homebrew/opt/protobuf@3/bin:$PATH"
fi

##### Build flags
export LDFLAGS="-L/opt/homebrew/opt/libiconv/lib"
export CPPFLAGS="-I/opt/homebrew/opt/libiconv/include"

##### Secrets helpers
load_secret() {
    local secret_path=$1
    local var_name=$2
    export "$var_name"="$(op read --account my.1password.com "op://$secret_path")"
}

load_all_secrets() {
    eval "$(manage_secrets.py)"
    echo "All secrets have been loaded."
}

##### Aliases & helpers
alias ll='eza -lh --git'
alias ls="gls --color"
alias du="dust"
alias pmc='coyote test'
alias zstd=$(brew --prefix zstd)/bin/zstd
alias vim=nvim
alias lg='GIT_CONFIG_GLOBAL=~/.gitconfig-lazygit lazygit'
alias ar=/usr/bin/ar

export _ZO_RESOLVE_SYMLINKS=1
alias cd='z'

##### Session logging
if [[ -z "$LOGGING_STARTED" ]]; then
    export LOGGING_STARTED=1
    rotate_logs
fi

##### Zellij helpers
zr  () { command zellij run --name "$*"        -- zsh -ic "$*"; }
zrf () { command zellij run --floating --name "$*" -- zsh -ic "$*"; }
zri () { command zellij run --in-place --name "$*" -- zsh -ic "$*"; }

##### Atuin last to own Ctrl-R
eval "$(atuin init zsh)"
bindkey -M emacs '^R' _atuin_search_widget
bindkey -M viins '^R' _atuin_search_widget
bindkey -M vicmd '^R' _atuin_search_widget
